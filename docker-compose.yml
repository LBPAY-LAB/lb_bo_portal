version: '3.9'

# ===================================================================
# LB Portal Container - Development Stack
# ===================================================================
# Stack: PostgreSQL 15 + Keycloak 23 + Redis 7 + PayloadCMS 3.x
# Purpose: Local development environment
# Updated: 2025-11-09
# ===================================================================

services:
  # ===================================================================
  # PostgreSQL 15 - Main Database
  # ===================================================================
  postgres:
    image: postgres:15-alpine
    container_name: portal_postgres
    restart: unless-stopped

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-portal_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-portal_dev_pass}
      POSTGRES_DB: ${POSTGRES_DB:-payload_dev}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      # Performance tuning for development
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_MAX_CONNECTIONS: "200"

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-portal_user} -d ${POSTGRES_DB:-payload_dev}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - portal_network

    labels:
      com.lbpay.service: "database"
      com.lbpay.environment: "development"

  # ===================================================================
  # Keycloak 23 - Identity & Access Management (SSO)
  # ===================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: portal_keycloak
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
      - "${KEYCLOAK_ADMIN_PORT:-8443}:8443"

    environment:
      # Admin credentials (DEVELOPMENT ONLY)
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}

      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${KEYCLOAK_DB:-keycloak_dev}
      KC_DB_USERNAME: ${POSTGRES_USER:-portal_user}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-portal_dev_pass}

      # Development mode settings
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"

      # Logging
      KC_LOG_LEVEL: ${KEYCLOAK_LOG_LEVEL:-info}
      KC_LOG_CONSOLE_OUTPUT: "default"

      # Import realm on startup
      KC_IMPORT: ${KEYCLOAK_IMPORT_REALM:-/opt/keycloak/data/import/realm.json}

    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./docker/keycloak:/opt/keycloak/data/import:ro

    command:
      - start-dev
      - --import-realm

    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    networks:
      - portal_network

    labels:
      com.lbpay.service: "iam"
      com.lbpay.environment: "development"

  # ===================================================================
  # Redis 7 - Cache & Session Store
  # ===================================================================
  redis:
    image: redis:7-alpine
    container_name: portal_redis
    restart: unless-stopped

    ports:
      - "${REDIS_PORT:-6379}:6379"

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory ${REDIS_MAX_MEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000

    volumes:
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    networks:
      - portal_network

    labels:
      com.lbpay.service: "cache"
      com.lbpay.environment: "development"

# ===================================================================
# Named Volumes (Persistent Data)
# ===================================================================
volumes:
  postgres_data:
    name: portal_postgres_data
    driver: local
    labels:
      com.lbpay.backup: "daily"
      com.lbpay.retention: "7days"

  keycloak_data:
    name: portal_keycloak_data
    driver: local

  redis_data:
    name: portal_redis_data
    driver: local

# ===================================================================
# Custom Network
# ===================================================================
networks:
  portal_network:
    name: portal_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    labels:
      com.lbpay.project: "lb-portal-container"
      com.lbpay.environment: "development"
